import React, { useState, useContext } from "react";
import { Card, Suit, Rank } from "@poker-checker/common";

export interface ICardSlotData {
  id: number;
  card: Card;
}

export interface IHandData {
  id: string;
  name: string;
  slots: Array<ICardSlotData>;
}

export interface IRoundData {
  hands: Array<IHandData>;
}

const initialRoundData: IRoundData = {
  hands: [
    {
      id: "river",
      name: "Dealer",
      slots: [
        { id: 1, card: new Card(Suit.None, Rank.None) },
        { id: 2, card: new Card(Suit.None, Rank.None) },
        { id: 3, card: new Card(Suit.None, Rank.None) },
        { id: 4, card: new Card(Suit.None, Rank.None) },
        { id: 5, card: new Card(Suit.None, Rank.None) },
      ],
    },
    {
      id: "playerA",
      name: "Player 1",
      slots: [
        { id: 1, card: new Card(Suit.None, Rank.None) },
        { id: 2, card: new Card(Suit.None, Rank.None) },
      ],
    },
    {
      id: "playerB",
      name: "Player 2",
      slots: [
        { id: 1, card: new Card(Suit.None, Rank.None) },
        { id: 2, card: new Card(Suit.None, Rank.None) },
      ],
    },
  ],
};

export interface ISlotIdentifier {
  handId: string;
  slotId: number;
}

interface IHandEntryContext {
  // Round state variables
  roundData: IRoundData;
  getSlot: (
    handsData: IRoundData,
    handId: string,
    slotId: number
  ) => ICardSlotData | undefined;
  setCard: (handId: string, slotId: number, suit: Suit, rank: Rank) => void;

  // Card chooser modal
  chooserIsOpen: boolean;
  chooserSlot: { handId: string; slotId: number };
  closeChooser: () => void;
  openChooser: (handId: string, slotId: number) => void;
  setChooserSlot: (slotIndex: ISlotIdentifier) => void;
}

const handEntryContext = React.createContext<IHandEntryContext>(null);

export interface IProviderProps {
  children?: any;
}

const AppProvider = (props: IProviderProps) => {
  const [roundData] = useState<IRoundData>(initialRoundData);
  const [chooserIsOpen, setChooserIsOpen] = useState<boolean>(false);
  const [chooserSlot, setChooserSlot] = useState<{
    handId: string;
    slotId: number;
  }>({
    handId: "river",
    slotId: 1,
  });

  const openChooser = (handId: string, slotId: number) => {
    setChooserSlot({ handId: handId, slotId: slotId });
    setChooserIsOpen(true);
  };

  const closeChooser = () => {
    setChooserIsOpen(false);
  };

  const getSlot = (
    handsData: IRoundData,
    handId: string,
    slotId: number
  ): ICardSlotData | undefined => {
    let slot: ICardSlotData | undefined = undefined;
    let hand: IHandData | undefined = undefined;

    hand = handsData.hands.find((hand: IHandData) => hand.id === handId);
    if (hand !== undefined) {
      slot = hand.slots.find((slot: ICardSlotData) => slot.id === slotId);
    }

    return slot;
  };

  const setCard = (
    handId: string,
    slotId: number,
    suit: Suit,
    rank: Rank
  ): void => {
    const newHands: IRoundData = { hands: [...roundData.hands] };
    const slot: ICardSlotData | undefined = getSlot(newHands, handId, slotId);
    const card: Card = new Card(suit, rank);

    if (slot !== undefined) {
      slot.card = card;
    }
  };

  return (
    // Provide the various functions and state variables to the global state, using context
    <handEntryContext.Provider
      value={{
        chooserIsOpen,
        chooserSlot,
        closeChooser,
        getSlot,
        roundData,
        openChooser,
        setChooserSlot,
        setCard,
      }}
    >
      {props.children}
    </handEntryContext.Provider>
  );
};

export const useHandEntryContext = () => {
  return useContext(handEntryContext);
};

export { handEntryContext as AppContext, AppProvider };
